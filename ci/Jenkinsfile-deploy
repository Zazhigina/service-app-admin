#!groovy

// import shared library
@Library("dsoLibrary@master") _

// populate variables from folder
withFolderProperties{
    DEPLOY_ENVIRONMENT = "${env.DEPLOY_ENVIRONMENT}"
    OCP_URL_TARGET = "${env.OCP_URL_TARGET}"
    OCP_NAMESPACE = "${env.OCP_NAMESPACE}"
    OCP_APP_NAME = "${env.OCP_APP_NAME}"
    OCP_CRED_ID = "${env.OCP_CRED_ID}"
    VAULT_URL = "${env.VAULT_URL}"
    LANDSCAPE_ID = "${env.LANDSCAPE_ID}"
    PROJECT_ID = "${env.PROJECT_ID}"
    CLUSTER_ID = "${env.CLUSTER_ID}"
    REGISTRY_TRUST = "${env.REGISTRY_TRUST}"
    REGISTRY_TRUST_CRED_ID = "${env.REGISTRY_TRUST_CRED_ID}"
    REGISTRY_DEV = "${env.REGISTRY_DEV}"
    REGISTRY_DEV_CRED_ID = "${env.REGISTRY_DEV_CRED_ID}"
    PROD_REGISTRY_TRUST = "${env.PROD_REGISTRY_TRUST}"
    PROD_REGISTRY_TRUST_CRED_ID = "${env.PROD_REGISTRY_TRUST_CRED_ID}"
}

if (DEPLOY_ENVIRONMENT == 'trust' && (LANDSCAPE_ID == 'prod' || LANDSCAPE_ID == 'preprod' || LANDSCAPE_ID == 'prod-cdmz' || LANDSCAPE_ID == 'preprod-cdmz')) {
    REGISTRY = PROD_REGISTRY_TRUST
    REGISTRY_CRED_ID = PROD_REGISTRY_TRUST_CRED_ID
    CHART_VERSION = '1.0.1'
    HELM_VALUES_NAME = 'prod'
    KUBE_TYPE = "ocp"
} else if (DEPLOY_ENVIRONMENT == 'trust' && LANDSCAPE_ID == 'uat' && CLUSTER_ID == 'uat4') {
    REGISTRY = REGISTRY_TRUST
    REGISTRY_CRED_ID = REGISTRY_TRUST_CRED_ID
    CHART_VERSION = '1.0.1'
    HELM_VALUES_NAME = 'trust'
    KUBE_TYPE = "ocp"
} else if (DEPLOY_ENVIRONMENT == 'trust' && LANDSCAPE_ID == 'uat' && CLUSTER_ID == 'spb99dhu') {
    REGISTRY = REGISTRY_TRUST
    REGISTRY_CRED_ID = REGISTRY_TRUST_CRED_ID
    CHART_VERSION = '1.0.1'
    HELM_VALUES_NAME = 'trust'
    KUBE_TYPE = "k8s"
} else if (DEPLOY_ENVIRONMENT == 'dev') {
    REGISTRY = REGISTRY_DEV
    REGISTRY_CRED_ID = REGISTRY_DEV_CRED_ID
    CHART_VERSION = '1.0.1'
    HELM_VALUES_NAME = 'dev'
    KUBE_TYPE = "ocp"
}

pipeline {
    agent {
        label "$DEPLOY_ENVIRONMENT"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '100', artifactNumToKeepStr: '100'))
        timeout(time: 30, unit: 'MINUTES')
    }

    environment {
        GIT_COMMIT_SHORT = sh(
                script: "printf \$(git rev-parse --short=7 ${GIT_COMMIT})",
                returnStdout: true
        )
    }

    stages {
        stage("Set build name") {
            steps {
                script {
                    buildSetter()
                }
            }
        }

        stage("Set SUFFIX") {
            steps {
                script {
                    if ("${DEPLOY_ENVIRONMENT}" == 'trust' && "${LANDSCAPE_ID}" == 'uat' && "${CLUSTER_ID}" == 'uat4') {
                        SUFFIX = "-test"
                        echo 'Current suffix: ' + "${SUFFIX}"
                    } else if ("${DEPLOY_ENVIRONMENT}" == 'trust' && "${LANDSCAPE_ID}" == 'uat' && "${CLUSTER_ID}" == 'spb99dhu') {
                        SUFFIX = ""
                        echo 'Current suffix: ' + "${SUFFIX}"
                    } else {
                        SUFFIX = ""
                    }
                }
            }
        }

        stage("Helm deploy") {
            steps {
                withKubeConfig([login_type: "${KUBE_TYPE}", auth_provider: "vault"]) {
                    doHelm "install", [
                            helm_chart: "tzriu-be-spring",
                            from_repo: true,
                            helm_commands: "--version ${CHART_VERSION} \
                            --reset-values \
                            --set image.repository=${REGISTRY}/${OCP_NAMESPACE}/${OCP_APP_NAME} \
                            --set image.tag=${GIT_COMMIT_SHORT} \
                            -f ./ci/helm/values-${HELM_VALUES_NAME}${SUFFIX}.yaml"
                    ]
                }
            }
        }
    }

}

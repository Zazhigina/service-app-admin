deploy:
  stage: deploy
  needs: ["build"]
  image: registry.inlinegroup-c.ru/tools/bitnami/kubectl:local
  environment:
    name: development
    url: $APP_URL/actuator
    action: start
    on_stop: stop_deploy
    kubernetes:
      namespace: mirror
  script:
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/ingress.yml
    - sed -i "s|\$APP_ROOT|$APP_ROOT|g" ci/trunk/k8s/ingress.yml
    - sed -i "s|\$APP_HOST|$APP_HOST|g" ci/trunk/k8s/ingress.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/ingress.yml --ignore-not-found=true
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/service.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/service.yml --ignore-not-found=true
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/deployment.yml
    - sed -i "s|\$CONTAINER_IMAGE|$CI_REGISTRY_IMAGE|g" ci/trunk/k8s/deployment.yml
    - sed -i "s|\$APPLICATION_VERSION|$APPLICATION_VERSION|g" ci/trunk/k8s/deployment.yml
    - sed -i "s|\$ACTIVE_PROFILE|$ACTIVE_PROFILE|g" ci/trunk/k8s/deployment.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/deployment.yml --ignore-not-found=true
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/configmap.yml
    - sed -i "s|\$APP_HOST|$APP_HOST|g" ci/trunk/k8s/configmap.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/configmap.yml --ignore-not-found=true
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} apply -f ci/trunk/k8s/ingress.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} apply -f ci/trunk/k8s/service.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} apply -f ci/trunk/k8s/configmap.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} apply -f ci/trunk/k8s/deployment.yml
  rules:
    - if: $CI_COMMIT_BRANCH == $DEPLOY_BRANCH

stop_deploy:
  stage: deploy
  image: registry.inlinegroup-c.ru/tools/bitnami/kubectl:local
  environment:
    name: development
    action: stop
  when: manual
  script:
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/ingress.yml
    - sed -i "s|\$APP_ROOT|$APP_ROOT|g" ci/trunk/k8s/ingress.yml
    - sed -i "s|\$APP_HOST|$APP_HOST|g" ci/trunk/k8s/ingress.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/ingress.yml --ignore-not-found=true
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/service.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/service.yml --ignore-not-found=true
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/deployment.yml
    - sed -i "s|\$CONTAINER_IMAGE|$CI_REGISTRY_IMAGE|g" ci/trunk/k8s/deployment.yml
    - sed -i "s|\$APPLICATION_VERSION|$APPLICATION_VERSION|g" ci/trunk/k8s/deployment.yml
    - sed -i "s|\$ACTIVE_PROFILE|$ACTIVE_PROFILE|g" ci/trunk/k8s/deployment.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/deployment.yml --ignore-not-found=true
    - sed -i "s|\$CONTAINER_NAME|$CONTAINER_NAME|g" ci/trunk/k8s/configmap.yml
    - sed -i "s|\$APP_HOST|$APP_HOST|g" ci/trunk/k8s/configmap.yml
    - kubectl -n ${KUBERNETES_NAMESPACE_OVERWRITE} delete -f ci/trunk/k8s/configmap.yml --ignore-not-found=true


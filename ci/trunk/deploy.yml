deploy:
  stage: deploy
  image: registry.inlinegroup-c.ru/tools/devth/helm:v3.9.0
  environment:
    name: $ENVIRONMENT_NAME
    url: $APP_URL
    action: start
    on_stop: stop_deploy
  script:
    - helm repo add --username ${NEXUS_USER} --password ${NEXUS_USER_PASSWORD} helm-hosted ${NEXUS_HELM_REPO}
    - helm upgrade
      --reuse-values
      --install ${APPLICATION_NAME}
      --namespace ${KUBERNETES_NAMESPACE_OVERWRITE}
      --set image.repository=$IMAGE_REPOSITORY
      --set image.tag=$APPLICATION_VERSION
      -f ./ci/helm/values-trunk.yaml
      helm-hosted/${CHART_NAME}
  rules:
    - if: $CI_COMMIT_BRANCH == $DEPLOY_BRANCH

stop_deploy:
  stage: deploy
  image: registry.inlinegroup-c.ru/tools/devth/helm:v3.9.0
  environment:
    name: $ENVIRONMENT_NAME
    action: stop
  when: manual
  script:
    - 'helm delete ${APPLICATION_NAME} --namespace ${KUBERNETES_NAMESPACE_OVERWRITE}'
  rules:
    - if: $CI_COMMIT_BRANCH == $DEPLOY_BRANCH
